{
  "name": "PI-Evri-Sec-Baseline",
  "type": "Microsoft.Authorization/policySetDefinitions",
  "apiVersion": "2024-04-01",
  "properties": {
    "policyType": "Custom",
    "displayName": "EVRi Security Baseline",
    "description": "MC: Key Vault baseline (disable PNA, enable soft delete & purge protection, prefer RBAC, enable diagnostics, enforce key rotation).",
    "metadata": { "version": "1.0.0", "category": "Security" },
    "parameters": {
      "kvKeyRotationDays": {
        "type": "Integer",
        "metadata": {
          "displayName": "Key rotation schedule (days)",
          "description": "Max days after creation until a key must have a rotation policy."
        },
        "defaultValue": 365
      }
    },
    "policyDefinitions": [
      {
        "policyDefinitionReferenceId": "KV-DisablePublicNetworkAccess-Deny-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/405c5871-3e91-4644-8a63-58e19d68ff5b",
        "parameters": {},
        "groupNames": ["Resource-Baseline-Security"]
      },
      {
        "policyDefinitionReferenceId": "KV-SoftDelete-Enabled-Deny-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d",
        "parameters": {},
        "groupNames": ["Resource-Baseline-Security"]
      },
      {
        "policyDefinitionReferenceId": "KV-PurgeProtection-Enabled-Deny-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/0b60c0b2-2dc2-4e1c-b5c9-abbed971de53",
        "parameters": {},
        "groupNames": ["Resource-Baseline-Security"]
      },
      {
        "policyDefinitionReferenceId": "KV-UseRBAC-PermissionModel-Audit-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/12d4fa5e-1f9f-4c21-97a9-b99b3c6611b5",
        "parameters": {},
        "groupNames": ["Resource-Baseline-Security"]
      },
      {
        "policyDefinitionReferenceId": "KV-DiagnosticLogs-AuditIfNotExists-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/cf820ca0-f99e-4f3e-84fb-66e913812d21",
        "parameters": {},
        "groupNames": ["Resource-Baseline-Security"]
      },
      {
        "policyDefinitionReferenceId": "KV-KeyRotation-Audit-001",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/d8cf8476-a2ec-4916-896e-992351803c44",
        "parameters": {
          "maximumDaysToRotate": {
            "value": "[parameters('kvKeyRotationDays')]"
          }
        },
        "groupNames": ["Resource-Baseline-Security"]
      }
    ],
    "policyDefinitionGroups": [
      {
        "name": "Resource-Baseline-Security",
        "displayName": "Resource Baseline - Security",
        "description": "Group for Key Vault security baseline controls."
      }
    ]
  }
}
